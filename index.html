<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global CRM - Data Persistent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-nav { @apply bg-blue-600 text-white !important; }
        .inactive-nav { @apply hover:bg-slate-800 text-slate-400 hover:text-white !important; }
        .modal-active { display: flex !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="flex min-h-screen relative">
        <!-- ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ -->
        <div id="toast" class="fixed bottom-5 right-5 z-[110] bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300"></div>

        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-white p-6 shadow-xl z-50 lg:relative lg:translate-x-0 transition-transform duration-300">
            <div class="flex items-center gap-3 mb-10 px-2">
                <div class="p-2 bg-blue-500 rounded-lg">
                    <i data-lucide="globe" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-xl font-bold tracking-tight">Global CRM</span>
            </div>
            
            <nav class="space-y-2 flex-1">
                <button onclick="changeView('dashboard')" id="nav-dashboard" class="nav-item flex items-center gap-3 w-full p-3 rounded-xl active-nav font-medium transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> ÎåÄÏãúÎ≥¥Îìú
                </button>
                <button onclick="changeView('management')" id="nav-management" class="nav-item flex items-center gap-3 w-full p-3 rounded-xl inactive-nav transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i> Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨
                </button>
                <button onclick="changeView('analysis')" id="nav-analysis" class="nav-item flex items-center gap-3 w-full p-3 rounded-xl inactive-nav transition-all">
                    <i data-lucide="trending-up" class="w-5 h-5"></i> Îß§Ï∂ú Î∂ÑÏÑù
                </button>
            </nav>

            <div class="mt-10 p-4 bg-slate-800 rounded-2xl">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-sm font-medium">Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Ï†ÄÏû• ÌôúÏÑ±</span>
                </div>
            </div>
        </aside>

        <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
        <main class="flex-1 w-full p-4 md:p-8 overflow-y-auto h-screen">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Ìï¥Ïô∏Í±∞ÎûòÏÑ† ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-slate-500 text-sm">Í∏∞Ï§Ä Ïó∞ÎèÑ:</span>
                        <select id="yearSelect" onchange="handleYearChange(this.value)" class="bg-white border border-slate-200 rounded-lg text-sm font-bold px-2 py-1 outline-none">
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-white border border-slate-200 px-3 py-1.5 rounded-xl shadow-sm">
                        <span class="text-xs font-bold text-slate-500 uppercase">Admin Mode</span>
                        <button id="adminToggle" onclick="toggleAdminMode()" class="w-10 h-5 bg-slate-200 rounded-full relative transition-colors duration-200">
                            <div id="toggleDot" class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform duration-200"></div>
                        </button>
                    </div>
                    <button onclick="openModal()" id="addBtn" class="hidden flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i> Í±∞ÎûòÏ≤ò Îì±Î°ù
                    </button>
                </div>
            </header>

            <!-- Î∑∞: ÎåÄÏãúÎ≥¥Îìú -->
            <div id="dashboardView" class="view-content">
                <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button onclick="updateTab('all')" id="tab-all" class="px-6 py-2 rounded-lg text-sm font-medium bg-white text-blue-600 shadow-sm transition-all">Ï†ÑÏ≤¥</button>
                            <button onclick="updateTab('Existing')" id="tab-Existing" class="px-6 py-2 rounded-lg text-sm font-medium text-slate-500 transition-all">Í∏∞Ï°¥</button>
                            <button onclick="updateTab('New')" id="tab-New" class="px-6 py-2 rounded-lg text-sm font-medium text-slate-500 transition-all">Ïã†Í∑ú</button>
                        </div>
                        <div class="relative w-full md:w-64">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" placeholder="Íµ≠Í∞Ä/Î∞îÏù¥Ïñ¥ Í≤ÄÏÉâ..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none" oninput="handleSearch(this.value)">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[900px]">
                            <thead>
                                <tr class="bg-slate-50 text-slate-500 text-xs font-semibold uppercase tracking-wider">
                                    <th class="px-6 py-4">Íµ≠Í∞Ä / ÏßÄÏó≠</th>
                                    <th class="px-6 py-4">Î∞îÏù¥Ïñ¥ Ï†ïÎ≥¥</th>
                                    <th class="px-6 py-4 text-right">Îß§Ï∂ú (USD)</th>
                                    <th class="px-6 py-4">Ïù∏Ï¶ù</th>
                                    <th class="px-6 py-4">ÏÉÅÌÉú</th>
                                    <th class="admin-only px-6 py-4 text-center hidden">Í¥ÄÎ¶¨</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Î∑∞: Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ -->
            <div id="managementView" class="view-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i> ÎåÄÎ•ôÎ≥Ñ Íµ≠Í∞Ä Ïπ¥ÌÖåÍ≥†Î¶¨
                            </h3>
                            <div id="continentList" class="space-y-1"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <span id="currentFilterLabel" class="text-sm font-bold text-blue-600">ÏßÄÏó≠Î≥Ñ Í±∞ÎûòÏÑ†</span>
                                <span id="filterCount" class="text-xs text-slate-400">0Í∞ú Ìï≠Î™©</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[700px]">
                                    <thead>
                                        <tr class="bg-slate-50 text-slate-500 text-xs font-semibold uppercase">
                                            <th class="px-6 py-4">Íµ≠Í∞Ä/ÏßÄÏó≠</th>
                                            <th class="px-6 py-4">Î∞îÏù¥Ïñ¥Î™Ö</th>
                                            <th class="px-6 py-4 text-right">Îß§Ï∂úÏï°</th>
                                            <th class="admin-only px-6 py-4 text-center hidden">Í¥ÄÎ¶¨</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managementTableBody" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Í≥µÏßÄ Î∞è ÌååÏùº -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden mb-8">
                    <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="megaphone" class="w-5 h-5 text-amber-500"></i> ÏóÖÎ¨¥ ÏßÄÏõê ÏÑºÌÑ∞ (Í≥µÏßÄ Î∞è ÏûêÎ£å)
                        </h3>
                        <button onclick="openNoticeModal()" class="admin-only hidden px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-medium">ÏÉà Ìï≠Î™© Îì±Î°ù</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 text-slate-500 text-xs font-semibold uppercase">
                                <tr>
                                    <th class="px-6 py-4 w-16 text-center">No</th>
                                    <th class="px-6 py-4">Íµ¨Î∂Ñ</th>
                                    <th class="px-6 py-4">Ï†úÎ™©</th>
                                    <th class="px-6 py-4">ÎÇ†Ïßú</th>
                                    <th class="px-6 py-4">Ï≤®Î∂ÄÌååÏùº</th>
                                    <th class="admin-only px-6 py-4 text-center hidden">ÏÇ≠Ï†ú</th>
                                </tr>
                            </thead>
                            <tbody id="noticeTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Î∑∞: Îß§Ï∂ú Î∂ÑÏÑù -->
            <div id="analysisView" class="view-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i> Ïã§Ï†Å ÏãúÍ∞ÅÌôî (<span id="analysisYearLabel"></span>)
                    </h2>
                    <button onclick="downloadExcel()" class="flex items-center gap-2 px-5 py-2.5 bg-emerald-600 text-white rounded-xl shadow-lg hover:bg-emerald-700 transition-all font-bold">
                        <i data-lucide="download" class="w-4 h-4"></i> ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú (CSV)
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm text-center flex flex-col items-center justify-center">
                        <div class="p-4 bg-blue-50 text-blue-600 rounded-full mb-4"><i data-lucide="coins" class="w-10 h-10"></i></div>
                        <h3 class="text-slate-500 font-medium mb-1">Ï¥ù ÎàÑÏ†Å Ïã§Ï†Å</h3>
                        <p class="text-4xl font-black text-slate-900" id="analysisTotalSales">$0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4"></i> ÎåÄÎ•ôÎ≥Ñ Îß§Ï∂ú ÎπÑÏ§ë</h3>
                        <div id="continentBreakdown" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2"><i data-lucide="flag" class="w-4 h-4"></i> Íµ≠Í∞ÄÎ≥Ñ Îß§Ï∂ú ÎπÑÏ§ë</h3>
                        <div id="countryBreakdown" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- [Î™®Îã¨] Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ -->
    <div id="editModal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold">Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Îì±Î°ù/ÏàòÏ†ï</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <form id="dataForm" class="p-6 space-y-4">
                <input type="hidden" id="editIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Íµ≠Í∞ÄÎ™Ö</label><input type="text" id="formCountry" required class="w-full px-4 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ÎåÄÎ•ô</label>
                        <select id="formRegion" class="w-full px-4 py-2 border rounded-xl outline-none">
                            <option>ÏïÑÏãúÏïÑ</option><option>Î∂ÅÏïÑÎ©îÎ¶¨Ïπ¥</option><option>ÎÇ®ÏïÑÎ©îÎ¶¨Ïπ¥</option><option>Ïú†ÎüΩ</option><option>Ïò§ÏÑ∏ÏïÑÎãàÏïÑ</option><option>ÏïÑÌîÑÎ¶¨Ïπ¥</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ÎèÑÏãú</label><input type="text" id="formCity" class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Î∞îÏù¥Ïñ¥Î™Ö</label><input type="text" id="formBuyer" required class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Îß§Ï∂úÏï°(USD)</label><input type="number" id="formSales" step="0.01" class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ÏÉÅÌÉú</label>
                        <select id="formStatus" class="w-full px-4 py-2 border rounded-xl outline-none">
                            <option value="Existing">Í∏∞Ï°¥</option><option value="New">Ïã†Í∑ú</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Ï∑®ÏÜå</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Ï†ÄÏû•ÌïòÍ∏∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- [Î™®Îã¨] Íµ≠Í∞Ä Ï∂îÍ∞Ä -->
    <div id="countryModal" class="fixed inset-0 bg-slate-900/60 z-[105] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="font-bold">Íµ≠Í∞Ä Ï∂îÍ∞Ä</h3>
                <button onclick="closeCountryModal()" class="p-2"><i data-lucide="x"></i></button>
            </div>
            <form id="countryForm" class="p-6 space-y-4">
                <input type="hidden" id="targetContinent">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Íµ≠Í∞ÄÎ™Ö</label><input type="text" id="newCountryName" required class="w-full px-4 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ïòà: üá∫üá∏ ÎØ∏Íµ≠"></div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Ï∂îÍ∞Ä</button>
            </form>
        </div>
    </div>

    <!-- [Î™®Îã¨] Í≥µÏßÄ Îì±Î°ù -->
    <div id="noticeModal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="font-bold">Í≥µÏßÄÏÇ¨Ìï≠ Î∞è ÏûêÎ£å Îì±Î°ù</h3>
                <button onclick="closeNoticeModal()" class="p-2"><i data-lucide="x"></i></button>
            </div>
            <form id="noticeForm" class="p-6 space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Ïπ¥ÌÖåÍ≥†Î¶¨</label><select id="noticeCategory" class="w-full px-4 py-2 border rounded-xl"><option>Í≥µÏßÄÏÇ¨Ìï≠</option><option>Îß§Îâ¥Ïñº</option><option>Í∑úÏ†úÏûêÎ£å</option></select></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Ï†úÎ™©</label><input type="text" id="noticeTitle" required class="w-full px-4 py-2 border rounded-xl"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Ï≤®Î∂ÄÌååÏùºÎ™Ö</label><input type="text" id="noticeFile" class="w-full px-4 py-2 border rounded-xl"></div>
                <button type="submit" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Îì±Î°ù</button>
            </form>
        </div>
    </div>

    <script>
        // --- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ (LocalStorage) ---
        const LOCAL_KEY = 'GLOBAL_CRM_PERSISTENT_STORAGE';
        
        const initialSetup = {
            records: {
                "2026": [
                    { country: "Ï§ëÍµ≠", region: "ÏïÑÏãúÏïÑ", city: "ÏÉÅÌï¥", buyer: "KC Ïù¥ÎÑàÎ≤®Îùº", sales25: 150000, cert: "NMPA", contact: "ÏñëÏäπÎ£°", status: "Existing" },
                    { country: "ÎØ∏Íµ≠", region: "Î∂ÅÏïÑÎ©îÎ¶¨Ïπ¥", city: "LA", buyer: "Relaxation Spa", sales25: 85000, cert: "FDA", contact: "Astrid", status: "New" }
                ]
            },
            continents: {
                'ÏïÑÏãúÏïÑ': ['ÌïúÍµ≠', 'Ï§ëÍµ≠', 'ÏùºÎ≥∏', 'Î≤†Ìä∏ÎÇ®', 'ÌÉúÍµ≠'],
                'Î∂ÅÏïÑÎ©îÎ¶¨Ïπ¥': ['ÎØ∏Íµ≠', 'Ï∫êÎÇòÎã§'],
                'Ïú†ÎüΩ': ['ÎèÖÏùº', 'ÌîÑÎûëÏä§', 'ÏòÅÍµ≠'],
                'ÎÇ®ÏïÑÎ©îÎ¶¨Ïπ¥': ['Î∏åÎùºÏßà'], 'Ïò§ÏÑ∏ÏïÑÎãàÏïÑ': ['Ìò∏Ï£º'], 'ÏïÑÌîÑÎ¶¨Ïπ¥': ['ÎÇ®ÏïÑÍ≥µ']
            },
            notices: [
                { id: 1, category: 'Í≥µÏßÄÏÇ¨Ìï≠', title: '2026ÎÖÑ Ìï¥Ïô∏ ÏÇ¨ÏóÖ Í≥ÑÌöç Í∞ÄÏù¥ÎìúÎùºÏù∏ Î∞∞Ìè¨', date: '2026-01-12', file: '2026_Plan_v1.pdf' }
            ]
        };

        // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        let db = JSON.parse(localStorage.getItem(LOCAL_KEY)) || initialSetup;

        let state = {
            isAdmin: false,
            selectedYear: 2026,
            currentView: 'dashboard',
            searchTerm: '',
            activeTab: 'all',
            selectedContinent: null,
            selectedCountry: null
        };

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò
        function saveDB() {
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
            render();
        }

        // --- Ï¥àÍ∏∞Ìôî Î∞è Ïó∞ÎèÑ ÏÑ§Ï†ï ---
        window.onload = () => {
            initYearSelect();
            render();
            lucide.createIcons();
        };

        function initYearSelect() {
            const select = document.getElementById('yearSelect');
            for (let y = 2020; y <= 2050; y++) {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = `${y}ÎÖÑ`;
                if (y === state.selectedYear) opt.selected = true;
                select.appendChild(opt);
            }
        }

        function handleYearChange(y) {
            state.selectedYear = parseInt(y);
            showToast(`${y}ÎÖÑ Îç∞Ïù¥ÌÑ∞Î°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§.`);
            render();
        }

        // --- UI Ïª®Ìä∏Î°§ ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function toggleAdminMode() {
            state.isAdmin = !state.isAdmin;
            document.getElementById('toggleDot').style.transform = state.isAdmin ? 'translateX(20px)' : 'translateX(0)';
            document.getElementById('adminToggle').classList.toggle('bg-blue-500', state.isAdmin);
            document.getElementById('adminToggle').classList.toggle('bg-slate-200', !state.isAdmin);
            document.getElementById('addBtn').classList.toggle('hidden', !state.isAdmin);
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !state.isAdmin));
            render();
        }

        function changeView(v) {
            state.currentView = v;
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${v}View`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active-nav');
                el.classList.add('inactive-nav');
            });
            document.getElementById(`nav-${v}`).className = "nav-item flex items-center gap-3 w-full p-3 rounded-xl active-nav font-medium transition-all";
            render();
        }

        // --- Î†åÎçîÎßÅ Î°úÏßÅ ---
        function render() {
            const yearData = db.records[state.selectedYear] || [];
            let filtered = [...yearData];

            if (state.currentView === 'dashboard') {
                filtered = filtered.filter(item => {
                    const matchSearch = item.country.includes(state.searchTerm) || item.buyer.includes(state.searchTerm);
                    const matchTab = state.activeTab === 'all' || item.status === state.activeTab;
                    return matchSearch && matchTab;
                });
                renderStats(filtered);
                renderDashboard(filtered);
            } else if (state.currentView === 'management') {
                if (state.selectedCountry) filtered = filtered.filter(item => item.country === state.selectedCountry);
                document.getElementById('currentFilterLabel').innerText = state.selectedCountry || "Ï†ÑÏ≤¥ ÏßÄÏó≠ ÌòÑÌô©";
                document.getElementById('filterCount').innerText = `${filtered.length}Í∞ú`;
                renderContinentList();
                renderManagement(filtered);
                renderNotices();
            } else if (state.currentView === 'analysis') {
                document.getElementById('analysisYearLabel').innerText = `${state.selectedYear}ÎÖÑ Ïã§Ï†ÅÎ∂ÑÏÑù`;
                renderAnalysis(yearData);
            }
            lucide.createIcons();
        }

        function renderStats(data) {
            const total = data.reduce((a, b) => a + b.sales25, 0);
            const grid = document.getElementById('statsGrid');
            const items = [
                { label: 'Ïó∞Í∞Ñ Îß§Ï∂úÏï°', value: `$${total.toLocaleString()}`, color: 'text-blue-600', bg: 'bg-blue-50', icon: 'dollar-sign' },
                { label: 'Í±∞ÎûòÏ≤ò Ïàò', value: data.length, color: 'text-emerald-600', bg: 'bg-emerald-50', icon: 'users' },
                { label: 'Ïã†Í∑ú ÌÉÄÍ≤ü', value: data.filter(d => d.status === 'New').length, color: 'text-amber-600', bg: 'bg-amber-50', icon: 'zap' },
                { label: 'ÏßÑÏ∂ú Íµ≠Í∞Ä', value: [...new Set(data.map(d => d.country))].length, color: 'text-purple-600', bg: 'bg-purple-50', icon: 'map' }
            ];
            grid.innerHTML = items.map(i => `
                <div class="bg-white p-6 rounded-2xl border border-slate-200">
                    <div class="flex items-center gap-3 mb-2"><div class="p-2 rounded-lg ${i.bg} ${i.color}"><i data-lucide="${i.icon}" class="w-5 h-5"></i></div><span class="text-xs font-bold text-slate-500">${i.label}</span></div>
                    <p class="text-2xl font-black text-slate-800">${i.value}</p>
                </div>
            `).join('');
        }

        function renderDashboard(data) {
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = data.map((item, idx) => {
                const globalIdx = db.records[state.selectedYear].indexOf(item);
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4"><div class="font-bold">${item.country}</div><div class="text-[10px] text-slate-400">${item.region}</div></td>
                        <td class="px-6 py-4"><div class="text-sm font-medium">${item.buyer}</div><div class="text-[10px] text-slate-400">${item.city}</div></td>
                        <td class="px-6 py-4 text-right font-black text-blue-600">$${item.sales25.toLocaleString()}</td>
                        <td class="px-6 py-4"><span class="px-2 py-0.5 bg-slate-100 text-[10px] rounded border">${item.cert || '-'}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${item.status === 'Existing' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${item.status === 'Existing' ? 'Í∏∞Ï°¥' : 'Ïã†Í∑ú'}</span></td>
                        ${state.isAdmin ? `<td class="px-6 py-4 text-center"><div class="flex justify-center gap-2">
                            <button onclick="openModal(${globalIdx})" class="text-blue-500"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteRecord(${globalIdx})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div></td>` : ''}
                    </tr>
                `;
            }).join('');
        }

        function renderManagement(data) {
            const tbody = document.getElementById('managementTableBody');
            tbody.innerHTML = data.map((item, idx) => {
                const globalIdx = db.records[state.selectedYear].indexOf(item);
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4"><div class="text-xs font-bold">${item.country}</div><div class="text-[10px] text-slate-400">${item.city}</div></td>
                        <td class="px-6 py-4 text-sm font-medium">${item.buyer}</td>
                        <td class="px-6 py-4 text-right font-bold text-blue-600">$${item.sales25.toLocaleString()}</td>
                        ${state.isAdmin ? `<td class="px-6 py-4 text-center">
                            <button onclick="deleteRecord(${globalIdx})" class="text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>` : ''}
                    </tr>
                `;
            }).join('');
        }

        function renderContinentList() {
            const container = document.getElementById('continentList');
            container.innerHTML = Object.keys(db.continents).map(cont => `
                <div class="mb-1">
                    <div class="flex items-center justify-between group px-2 py-1.5 hover:bg-slate-50 rounded-lg">
                        <button onclick="state.selectedContinent = state.selectedContinent === '${cont}' ? null : '${cont}'; render();" class="flex-1 text-left text-sm font-bold text-slate-700 flex items-center justify-between">
                            ${cont} <i data-lucide="chevron-right" class="w-3 h-3 transition-all ${state.selectedContinent === cont ? 'rotate-90' : ''}"></i>
                        </button>
                        <button onclick="openCountryModal('${cont}')" class="admin-only ${state.isAdmin ? '' : 'hidden'} text-blue-500 p-1"><i data-lucide="plus" class="w-3 h-3"></i></button>
                    </div>
                    <div class="${state.selectedContinent === cont ? 'block' : 'hidden'} pl-4 space-y-0.5 mt-1">
                        ${db.continents[cont].map(country => `
                            <div class="flex items-center group/item pr-2">
                                <button onclick="state.selectedCountry = '${country}'; render();" class="flex-1 text-left py-1.5 px-2 text-xs rounded ${state.selectedCountry === country ? 'bg-blue-50 text-blue-600 font-bold' : 'text-slate-500 hover:bg-slate-50'}">${country}</button>
                                <button onclick="deleteCountry('${cont}', '${country}')" class="admin-only ${state.isAdmin ? '' : 'hidden'} opacity-0 group-item-hover:opacity-100 text-red-300 p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderNotices() {
            const tbody = document.getElementById('noticeTableBody');
            tbody.innerHTML = db.notices.map((n, i) => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-center text-xs text-slate-400">${i+1}</td>
                    <td class="px-6 py-4"><span class="px-2 py-0.5 bg-slate-100 text-[10px] font-bold text-slate-600 rounded">${n.category}</span></td>
                    <td class="px-6 py-4 text-sm font-medium">${n.title}</td>
                    <td class="px-6 py-4 text-xs text-slate-400">${n.date}</td>
                    <td class="px-6 py-4 text-xs text-blue-500 font-bold underline cursor-pointer">${n.file || '-'}</td>
                    ${state.isAdmin ? `<td class="px-6 py-4 text-center"><button onclick="db.notices.splice(${i},1);saveDB();" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                </tr>
            `).join('');
        }

        function renderAnalysis(data) {
            const total = data.reduce((a, b) => a + b.sales25, 0);
            document.getElementById('analysisTotalSales').innerText = `$${total.toLocaleString()}`;
            
            // ÎåÄÎ•ôÎ≥Ñ
            const contMap = {};
            data.forEach(d => contMap[d.region] = (contMap[d.region] || 0) + d.sales25);
            document.getElementById('continentBreakdown').innerHTML = Object.entries(contMap).sort((a,b)=>b[1]-a[1]).map(([k, v]) => {
                const per = total > 0 ? (v/total*100).toFixed(1) : 0;
                return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold"><span>${k}</span><span>$${v.toLocaleString()} (${per}%)</span></div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width:${per}%"></div></div></div>`;
            }).join('');

            // Íµ≠Í∞ÄÎ≥Ñ
            const countryMap = {};
            data.forEach(d => countryMap[d.country] = (countryMap[d.country] || 0) + d.sales25);
            document.getElementById('countryBreakdown').innerHTML = Object.entries(countryMap).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(([k, v]) => {
                const per = total > 0 ? (v/total*100).toFixed(1) : 0;
                return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold"><span>${k}</span><span>$${v.toLocaleString()} (${per}%)</span></div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-emerald-500 h-full" style="width:${per}%"></div></div></div>`;
            }).join('');
        }

        // --- Í∏∞Îä• Ìï®Ïàò ---
        function downloadExcel() {
            const data = db.records[state.selectedYear] || [];
            if(data.length === 0) return showToast("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
            let csv = "\uFEFFÏó∞ÎèÑ,Íµ≠Í∞Ä,ÎåÄÎ•ô,Î∞îÏù¥Ïñ¥,Îß§Ï∂úÏï°(USD),ÏÉÅÌÉú\n";
            data.forEach(d => csv += `${state.selectedYear},${d.country},${d.region},${d.buyer},${d.sales25},${d.status}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `GlobalCRM_Export_${state.selectedYear}.csv`;
            link.click();
            showToast("ÏóëÏÖÄ ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.");
        }

        function openModal(idx = -1) {
            document.getElementById('dataForm').reset();
            document.getElementById('editIndex').value = idx;
            if(idx > -1) {
                const item = db.records[state.selectedYear][idx];
                document.getElementById('formCountry').value = item.country;
                document.getElementById('formRegion').value = item.region;
                document.getElementById('formCity').value = item.city;
                document.getElementById('formBuyer').value = item.buyer;
                document.getElementById('formSales').value = item.sales25;
                document.getElementById('formStatus').value = item.status;
            }
            document.getElementById('editModal').classList.add('modal-active');
        }
        function closeModal() { document.getElementById('editModal').classList.remove('modal-active'); }

        document.getElementById('dataForm').onsubmit = (e) => {
            e.preventDefault();
            const idx = parseInt(document.getElementById('editIndex').value);
            const data = {
                country: document.getElementById('formCountry').value,
                region: document.getElementById('formRegion').value,
                city: document.getElementById('formCity').value,
                buyer: document.getElementById('formBuyer').value,
                sales25: parseFloat(document.getElementById('formSales').value || 0),
                status: document.getElementById('formStatus').value
            };
            if(!db.records[state.selectedYear]) db.records[state.selectedYear] = [];
            if(idx > -1) db.records[state.selectedYear][idx] = data;
            else db.records[state.selectedYear].unshift(data);
            saveDB(); closeModal(); showToast("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
        };

        function deleteRecord(idx) {
            if(confirm('Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                db.records[state.selectedYear].splice(idx, 1);
                saveDB();
            }
        }

        function openCountryModal(cont) { document.getElementById('targetContinent').value = cont; document.getElementById('countryModal').classList.add('modal-active'); }
        function closeCountryModal() { document.getElementById('countryModal').classList.remove('modal-active'); }
        document.getElementById('countryForm').onsubmit = (e) => {
            e.preventDefault();
            const cont = document.getElementById('targetContinent').value;
            const name = document.getElementById('newCountryName').value;
            if(!db.continents[cont].includes(name)) {
                db.continents[cont].push(name);
                saveDB(); closeCountryModal(); showToast("Íµ≠Í∞ÄÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
            }
        };

        function deleteCountry(cont, country) {
            if(confirm(`[${country}] Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Îç∞Ïù¥ÌÑ∞Îäî Î≥¥Ï°¥Îê©ÎãàÎã§.`)) {
                db.continents[cont] = db.continents[cont].filter(c => c !== country);
                saveDB();
            }
        }

        function openNoticeModal() { document.getElementById('noticeModal').classList.add('modal-active'); }
        function closeNoticeModal() { document.getElementById('noticeModal').classList.remove('modal-active'); }
        document.getElementById('noticeForm').onsubmit = (e) => {
            e.preventDefault();
            db.notices.unshift({
                id: Date.now(),
                category: document.getElementById('noticeCategory').value,
                title: document.getElementById('noticeTitle').value,
                date: new Date().toISOString().split('T')[0],
                file: document.getElementById('noticeFile').value
            });
            saveDB(); closeNoticeModal(); showToast("Í≥µÏßÄÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
        };

        function updateTab(tab) {
            state.activeTab = tab;
            ['all', 'Existing', 'New'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                el.className = (t === tab) ? "px-6 py-2 rounded-lg text-sm font-medium bg-white text-blue-600 shadow-sm transition-all" : "px-6 py-2 rounded-lg text-sm font-medium text-slate-500 transition-all";
            });
            render();
        }

        function handleSearch(v) { state.searchTerm = v; render(); }
    </script>
</body>
</html>